<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport"
          content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />
    <!-- A-Frame -->
    <script src="https://aframe.io/releases/0.9.2/aframe.min.js"></script>
    <!-- AR.js -->
    <script src="https://cdn.rawgit.com/jeromeetienne/AR.js/master/aframe/build/aframe-ar.min.js"></script>
    
    <script>
      // --- Patch cho canvas: đảm bảo context 2d luôn có willReadFrequently ---
      (function() {
        var originalGetContext = HTMLCanvasElement.prototype.getContext;
        HTMLCanvasElement.prototype.getContext = function(type, options) {
          if (type === "2d") {
            options = options || {};
            options.willReadFrequently = true;
          }
          return originalGetContext.call(this, type, options);
        };
      })();

      window.addEventListener("load", function () {
        // --- Patch cho THREE.Material để tránh cảnh báo markersAreaEnabled ---
        if (THREE && THREE.Material && !('markersAreaEnabled' in THREE.Material.prototype)) {
          THREE.Material.prototype.markersAreaEnabled = false;
        }

        // (Tuỳ chọn) Dispatch resize event sau 3 giây nếu cần
        setTimeout(function () {
          var resizeEvent = document.createEvent("UIEvents");
          resizeEvent.initUIEvent("resize", true, false, window, 0);
          window.dispatchEvent(resizeEvent);
        }, 3000);

        // --- Cấu hình chuyển đổi hình ảnh ---
        var currentImageIndex = 0;
        // Sử dụng asset reference để đảm bảo các hình ảnh đã preload
        var images = ["#image1", "#image2", "#image3"];
        
        // Biến cờ để đảm bảo audio chỉ khởi chạy 1 lần khi marker được phát hiện
        var audioStarted = false;

        // Đợi scene của A-Frame được load xong
        var sceneEl = document.querySelector("a-scene");
        sceneEl.addEventListener("loaded", function () {
          var imageElement = document.getElementById("img1");
          var marker = document.getElementById("marker");
          var audioEntity = document.getElementById("audio-entity");
          var intervalSet = false; // Đảm bảo chỉ khởi tạo interval 1 lần

          // (Tuỳ chọn) Khi texture được load, điều chỉnh các thuộc tính để tránh resize không cần thiết
          imageElement.addEventListener("materialtextureloaded", function (e) {
            var texture = e.detail.texture;
            texture.generateMipmaps = false;
            texture.minFilter = THREE.LinearFilter;
          });

          // Khi marker được phát hiện
          marker.addEventListener("markerFound", function () {
            // Nếu audio chưa được khởi chạy, phát audio và đánh dấu đã phát
            if (!audioStarted) {
              audioEntity.components.sound.playSound();
              audioStarted = true;
            }
            // Bắt đầu chuyển hình ảnh (chỉ chạy 1 lần)
            if (!intervalSet) {
              intervalSet = true;
              setInterval(function () {
                currentImageIndex = (currentImageIndex + 1) % images.length;
                imageElement.setAttribute("material", "src: " + images[currentImageIndex]);
                console.log("Current Image: " + images[currentImageIndex]);
              }, 3000);
            }
          });

          // Khi marker mất, dừng audio và reset cờ
          marker.addEventListener("markerLost", function () {
            audioEntity.components.sound.stopSound();
            audioStarted = false;
          });
        });
      });
    </script>
  </head>

  <body style="margin: 0; overflow: hidden;">
    <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;">
      <a-assets>
        <!-- Assets hình ảnh -->
        <img id="image1" src="./media/image/cho-ben-thanh.jpg" />
        <img id="image2" src="./media/image/cho-ben-thanh2.jpg" />
        <img id="image3" src="./media/image/cho-ben-thanh3.jpg" />
        <!-- Asset audio -->
        <audio id="audio1" src="media/Audio/bird.mp3"></audio>
      </a-assets>

      <a-marker preset="custom" type="pattern" url="./marker/btn2-50.patt" id="marker">
        <!-- Hiển thị hình ảnh và text -->
        <a-image
          id="img1"
          src="#image1"
          width="16"
          height="9"
          position="0 0 0"
          rotation="-90 0 0"
          scale="0.1 0.2 1"
          visible="true">
        </a-image>
        <a-text
          id="text1"
          value="Cho ben thanh"
          color="#FFFFFF"
          width="3"
          align="center"
          position="0 1.3 0"
          rotation="-90 0 0"
          visible="true">
        </a-text>
        <!-- Entity chứa audio; loop: true để đảm bảo audio phát liên tục -->
        <a-entity id="audio-entity" sound="src: #audio1; autoplay: false; loop: true"></a-entity>
      </a-marker>

      <a-entity camera></a-entity>
    </a-scene>
  </body>
</html>
