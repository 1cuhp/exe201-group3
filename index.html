<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"
    />
    <!-- A-Frame -->
    <script src="https://aframe.io/releases/0.9.2/aframe.min.js"></script>
    <!-- AR.js -->
    <script src="https://cdn.rawgit.com/jeromeetienne/AR.js/master/aframe/build/aframe-ar.min.js"></script>

    <script>
      window.addEventListener("load", () => {
        // PATCH tr√°nh l·ªói markersAreaEnabled trong THREE.js
        if (typeof THREE !== "undefined" && THREE.Material && !("markersAreaEnabled" in THREE.Material.prototype)) {
          THREE.Material.prototype.markersAreaEnabled = false;
        }

        // Dispatch resize event sau 3 gi√¢y ƒë·ªÉ ·ªïn ƒë·ªãnh camera AR.js
        setTimeout(() => {
          window.dispatchEvent(new UIEvent("resize", { bubbles: true, cancelable: false }));
        }, 3000);

        // Bi·∫øn l∆∞u tr·∫°ng th√°i √¢m thanh v√† h√¨nh ·∫£nh
        let audioElement = new Audio("./media/Audio/chobenthanh.mp4"); // √Çm thanh kh√¥ng reset m·ªói l·∫ßn marker xu·∫•t hi·ªán
        let imageIndex = 0; // Ch·ªâ s·ªë ·∫£nh hi·ªán t·∫°i
        const imageSources = ["#image1", "#image2", "#image3"]; // D√πng ID t·ª´ <a-assets>
        let intervalSet = false; // ƒê·∫£m b·∫£o setInterval ch·ªâ ch·∫°y m·ªôt l·∫ßn

        const marker = document.getElementById("marker");
        const imageElement = document.getElementById("img1");

        // H√†m ph√°t audio
        function playAudio() {
          audioElement.currentTime = 0;
          audioElement.play()
            .then(() => console.log("üîä Ph√°t √¢m thanh th√†nh c√¥ng"))
            .catch(err => console.warn("‚ùå L·ªói ph√°t √¢m thanh:", err));
        }

        // Khi marker xu·∫•t hi·ªán, ph√°t √¢m thanh v√† b·∫Øt ƒë·∫ßu chuy·ªÉn ·∫£nh
        marker.addEventListener("markerFound", () => {
          console.log("üìç Marker ƒë∆∞·ª£c ph√°t hi·ªán!");
          playAudio();

          if (!intervalSet) {
            intervalSet = true;
            setInterval(() => {
              imageIndex = (imageIndex + 1) % imageSources.length; // Chuy·ªÉn ·∫£nh theo th·ª© t·ª±
              console.log(`üñº ƒêang chuy·ªÉn sang ·∫£nh: ${imageSources[imageIndex]}`);

              // C·∫≠p nh·∫≠t h√¨nh ·∫£nh b·∫±ng c√°ch ƒë·ªïi `material.src`
              imageElement.setAttribute("material", "src", imageSources[imageIndex]);
              console.log(`‚úÖ ·∫¢nh ƒë√£ c·∫≠p nh·∫≠t: ${imageSources[imageIndex]}`);
            }, 3000);
          }
        });

        // Khi marker m·∫•t, d·ª´ng √¢m thanh nh∆∞ng h√¨nh ·∫£nh v·∫´n ti·∫øp t·ª•c thay ƒë·ªïi
        marker.addEventListener("markerLost", () => {
          console.log("‚ùå Marker m·∫•t!");
          audioElement.pause();
          audioElement.currentTime = 0; // Reset v·ªÅ ƒë·∫ßu
        });
      });
    </script>
  </head>

  <body style="margin: 0; overflow: hidden;">
    <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;">
      <a-assets>
        <!-- Preload h√¨nh ·∫£nh -->
        <img id="image1" src="./media/image/cho-ben-thanh.jpg" />
        <img id="image2" src="./media/image/cho-ben-thanh2.jpg" />
        <img id="image3" src="./media/image/cho-ben-thanh3.jpg" />
      </a-assets>

      <a-marker preset="custom" type="pattern" url="./marker/btn2-50.patt" id="marker">
        <!-- Hi·ªÉn th·ªã h√¨nh ·∫£nh (·∫£nh s·∫Ω thay ƒë·ªïi li√™n t·ª•c) -->
        <a-image
          id="img1"
          material="src: #image1"
          width="16"
          height="9"
          position="0 0 0"
          rotation="-90 0 0"
          scale="0.1 0.2 1"
          visible="true">
        </a-image>
        
        <!-- Hi·ªÉn th·ªã ch·ªØ -->
        <a-text
          id="text1"
          value="Ch·ª£ B·∫øn Th√†nh"
          color="#FFFFFF"
          width="3"
          align="center"
          position="0 2 0"
          rotation="-90 0 0"
          visible="true">
        </a-text>
      </a-marker>

      <a-entity camera></a-entity>
    </a-scene>
  </body>
</html>
