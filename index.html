<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />
  <script src="https://aframe.io/releases/0.9.2/aframe.min.js"></script>
  <script src="https://cdn.rawgit.com/jeromeetienne/AR.js/master/aframe/build/aframe-ar.min.js"></script>
  <style>
    #close-button {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 10px 20px;
      font-size: 16px;
      background-color: red;
      color: white;
      border: none;
      cursor: pointer;
      display: none; /* ·∫®n n√∫t khi ch∆∞a c√≥ marker */
    }
  </style>
</head>
<body style="margin: 0; overflow: hidden">
  <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;">
    <a-assets>
      <!-- H√¨nh ·∫£nh Ch·ª£ B·∫øn Th√†nh -->
      <img id="image1" src="./media/image/cho-ben-thanh.jpg" />
      <img id="image2" src="./media/image/cho-ben-thanh2.jpg" />
      <img id="image3" src="./media/image/cho-ben-thanh3.jpg" />

      <!-- H√¨nh ·∫£nh Ch√πa M·ªôt C·ªôt -->
      <img id="image4" src="./media/image/chuamotcot1.jpg" />
      <img id="image5" src="./media/image/chuamotcot2.jpg" />
      <img id="image6" src="./media/image/chuamotcot3.jpg" />

      <!-- H√¨nh ·∫£nh Ch√πa V√†ng -->
      <img id="image7" src="./media/image/cv1.jpg" />
      <img id="image8" src="./media/image/cv2.jpg" />
      <img id="image9" src="./media/image/cv3.jpg" />

      <!-- H√¨nh ·∫£nh Ch√πa Som Rong -->
      <img id="image10" src="./media/image/csr1.jpg" />
      <img id="image11" src="./media/image/csr2.jpg" />
      <img id="image12" src="./media/image/csr3.jpg" />
    </a-assets>

    <!-- Marker Ch·ª£ B·∫øn Th√†nh -->
    <a-marker preset="custom" type="pattern" url="./marker/btn2-50.patt" id="marker-cho">
      <a-image id="img-cho" material="src: #image1" width="16" height="9" position="0 0 0" rotation="-90 0 0" scale="0.1 0.2 1" visible="false"></a-image>
    </a-marker>

    <!-- Marker Ch√πa M·ªôt C·ªôt -->
    <a-marker preset="custom" type="pattern" url="./marker/cmc-55.patt" id="marker-chua">
      <a-image id="img-chua" material="src: #image4" width="16" height="9" position="0 0 0" rotation="-90 0 0" scale="0.1 0.2 1" visible="false"></a-image>
    </a-marker>

    <!-- Marker Ch√πa V√†ng -->
    <a-marker preset="custom" type="pattern" url="./marker/cv-55.patt" id="marker-vang">
      <a-image id="img-vang" material="src: #image7" width="16" height="9" position="0 0 0" rotation="-90 0 0" scale="0.1 0.2 1" visible="false"></a-image>
    </a-marker>

    <!-- Marker Ch√πa Som Rong -->
    <a-marker preset="custom" type="pattern" url="./marker/csr-55.patt" id="marker-somrong">
      <a-image id="img-somrong" material="src: #image10" width="16" height="9" position="0 0 0" rotation="-90 0 0" scale="0.1 0.2 1" visible="false"></a-image>
    </a-marker>

    <a-entity camera></a-entity>
  </a-scene>

  <!-- N√∫t T·∫Øt -->
  <button id="close-button">T·∫Øt</button>

  <script>
    window.addEventListener("load", () => {
      let isLocked = false;
      let intervalId = null;
      let currentAudio = null;
      let currentImage = null;

      function setupMarker(markerId, imageElementId, audioSrc, imageSources) {
        let audio = new Audio(audioSrc);
        let imageIndex = 0;
        const marker = document.getElementById(markerId);
        const imageElement = document.getElementById(imageElementId);
        const closeButton = document.getElementById("close-button");

        marker.addEventListener("markerFound", () => {
          if (isLocked) return; // N·∫øu ƒë√£ kh√≥a, kh√¥ng ch·∫°y ti·∫øp

          console.log(`üìç Marker ${markerId} ƒë∆∞·ª£c ph√°t hi·ªán!`);
          isLocked = true;

          // Hi·ªán h√¨nh ·∫£nh
          currentImage = imageElement;
          currentImage.setAttribute("visible", "true");

          // Ph√°t √¢m thanh
          currentAudio = audio;
          currentAudio.currentTime = 0;
          currentAudio.play().catch((err) => console.warn("‚ùå L·ªói ph√°t √¢m thanh:", err));

          // Hi·ªán n√∫t "T·∫Øt"
          closeButton.style.display = "block";

          // ƒê·ªïi ·∫£nh m·ªói 3 gi√¢y
          if (!intervalId) {
            intervalId = setInterval(() => {
              imageIndex = (imageIndex + 1) % imageSources.length;
              imageElement.setAttribute("material", "src", imageSources[imageIndex]);
            }, 3000);
          }
        });

        marker.addEventListener("markerLost", () => {
          console.log(`‚ö† Marker ${markerId} m·∫•t, nh∆∞ng h√¨nh ·∫£nh v·∫´n gi·ªØ!`);
          if (isLocked) {
            currentImage.setAttribute("visible", "true"); // Gi·ªØ h√¨nh ·∫£nh
          }
        });

        closeButton.addEventListener("click", () => {
          if (isLocked) {
            console.log(`üîì ƒê√£ t·∫Øt n·ªôi dung c·ªßa ${markerId}`);
            isLocked = false;

            // D·ª´ng √¢m thanh
            if (currentAudio) {
              currentAudio.pause();
              currentAudio.currentTime = 0;
            }

            // D·ª´ng ƒë·ªïi ·∫£nh
            if (intervalId) {
              clearInterval(intervalId);
              intervalId = null;
            }

            // ·∫®n h√¨nh ·∫£nh
            if (currentImage) {
              currentImage.setAttribute("visible", "false");
            }

            // ·∫®n n√∫t "T·∫Øt"
            closeButton.style.display = "none";
          }
        });
      }

      // C·∫•u h√¨nh c√°c marker
      setupMarker("marker-cho", "img-cho", "./media/Audio/chobenthanh.mp4", ["#image1", "#image2", "#image3"]);
      setupMarker("marker-chua", "img-chua", "./media/Audio/chuamotcot.mp4", ["#image4", "#image5", "#image6"]);
      setupMarker("marker-vang", "img-vang", "./media/Audio/cauvang.mp4", ["#image7", "#image8", "#image9"]);
      setupMarker("marker-somrong", "img-somrong", "./media/Audio/chuasomrong.mp4", ["#image10", "#image11", "#image12"]);
    });
  </script>
</body>
</html>
