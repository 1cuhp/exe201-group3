<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />
  <script src="https://aframe.io/releases/0.9.2/aframe.min.js"></script>
  <script src="https://cdn.rawgit.com/jeromeetienne/AR.js/master/aframe/build/aframe-ar.min.js"></script>
  <style>
    #close-button {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 10px 20px;
      font-size: 16px;
      background-color: red;
      color: white;
      border: none;
      cursor: pointer;
      display: none; /* ·∫®n n√∫t khi ch∆∞a c√≥ marker */
    }
  </style>
</head>
<body style="margin: 0; overflow: hidden">
  <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;">
    <a-assets>
      <img id="image1" src="./media/image/cho-ben-thanh.jpg" />
      <img id="image2" src="./media/image/cho-ben-thanh2.jpg" />
      <img id="image3" src="./media/image/cho-ben-thanh3.jpg" />
    </a-assets>

    <!-- Marker -->
    <a-marker preset="custom" type="pattern" url="./marker/btn2-50.patt" id="marker-cho"></a-marker>

    <!-- H√¨nh ·∫£nh t√°ch kh·ªèi marker -->
    <a-image id="floating-image" material="src: #image1" width="16" height="9" position="0 2 -5" rotation="0 0 0" visible="false"></a-image>

    <a-entity camera></a-entity>
  </a-scene>

  <!-- N√∫t T·∫Øt -->
  <button id="close-button">T·∫Øt</button>

  <script>
    window.addEventListener("load", () => {
      let isLocked = false;
      let intervalId = null;
      let currentAudio = null;
      let currentImage = document.getElementById("floating-image");
      let closeButton = document.getElementById("close-button");
      let audio = new Audio("./media/Audio/chobenthanh.mp4");
      let imageIndex = 0;
      const imageSources = ["#image1", "#image2", "#image3"];

      document.getElementById("marker-cho").addEventListener("markerFound", () => {
        if (isLocked) return;
        isLocked = true;

        console.log("üìç Marker Ch·ª£ B·∫øn Th√†nh ƒë∆∞·ª£c ph√°t hi·ªán!");
        
        // Hi·ªÉn th·ªã h√¨nh ·∫£nh ·ªü v·ªã tr√≠ c·ªë ƒë·ªãnh
        currentImage.setAttribute("visible", "true");

        // Ph√°t √¢m thanh
        currentAudio = audio;
        currentAudio.currentTime = 0;
        currentAudio.play().catch(err => console.warn("‚ùå L·ªói ph√°t √¢m thanh:", err));

        // Hi·ªán n√∫t "T·∫Øt"
        closeButton.style.display = "block";

        // ƒê·ªïi ·∫£nh m·ªói 3 gi√¢y
        if (!intervalId) {
          intervalId = setInterval(() => {
            imageIndex = (imageIndex + 1) % imageSources.length;
            currentImage.setAttribute("material", "src", imageSources[imageIndex]);
          }, 3000);
        }
      });

      document.getElementById("marker-cho").addEventListener("markerLost", () => {
        console.log("‚ö† Marker m·∫•t, nh∆∞ng h√¨nh ·∫£nh v·∫´n gi·ªØ!");
        // Gi·ªØ h√¨nh ·∫£nh ngay c·∫£ khi m·∫•t marker
        currentImage.setAttribute("visible", "true");
      });

      closeButton.addEventListener("click", () => {
        if (isLocked) {
          console.log("üîì ƒê√£ t·∫Øt n·ªôi dung");

          // D·ª´ng √¢m thanh
          if (currentAudio) {
            currentAudio.pause();
            currentAudio.currentTime = 0;
          }

          // D·ª´ng ƒë·ªïi ·∫£nh
          if (intervalId) {
            clearInterval(intervalId);
            intervalId = null;
          }

          // ·∫®n h√¨nh ·∫£nh
          currentImage.setAttribute("visible", "false");

          // ·∫®n n√∫t "T·∫Øt"
          closeButton.style.display = "none";

          // Reset tr·∫°ng th√°i ƒë·ªÉ qu√©t l·∫°i
          isLocked = false;
        }
      });
    });
  </script>
</body>
</html>
