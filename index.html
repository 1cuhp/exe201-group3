<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"
    />
    <script src="https://aframe.io/releases/0.9.2/aframe.min.js"></script>
    <script src="https://cdn.rawgit.com/jeromeetienne/AR.js/master/aframe/build/aframe-ar.min.js"></script>
    <style>
      #close-button {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 10px 20px;
        font-size: 16px;
        background-color: red;
        color: white;
        border: none;
        cursor: pointer;
        display: none;
      }
    </style>
  </head>
  <body style="margin: 0; overflow: hidden">
    <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;">
      <a-assets>
        <!-- H√¨nh ·∫£nh cho t·ª´ng marker -->
        <img id="image1" src="./media/image/cho-ben-thanh.jpg" />
        <img id="image2" src="./media/image/cho-ben-thanh2.jpg" />
        <img id="image3" src="./media/image/cho-ben-thanh3.jpg" />

        <img id="image4" src="./media/image/chuamotcot1.jpg" />
        <img id="image5" src="./media/image/chuamotcot2.jpg" />
        <img id="image6" src="./media/image/chuamotcot3.jpg" />

        <img id="image7" src="./media/image/cv1.jpg" />
        <img id="image8" src="./media/image/cv2.jpg" />
        <img id="image9" src="./media/image/cv3.jpg" />

        <img id="image10" src="./media/image/csr1.jpg" />
        <img id="image11" src="./media/image/csr2.jpg" />
        <img id="image12" src="./media/image/csr3.jpg" />
      </a-assets>

      <!-- Marker -->
      <a-marker
        id="marker-cho"
        preset="custom"
        type="pattern"
        url="./marker/btn2-50.patt"
      ></a-marker>
      <a-marker
        id="marker-chua"
        preset="custom"
        type="pattern"
        url="./marker/cmc-55.patt"
      ></a-marker>
      <a-marker
        id="marker-vang"
        preset="custom"
        type="pattern"
        url="./marker/cv-55.patt"
      ></a-marker>
      <a-marker
        id="marker-somrong"
        preset="custom"
        type="pattern"
        url="./marker/csr-55.patt"
      ></a-marker>

      <!-- H√¨nh ·∫£nh c·ªë ƒë·ªãnh (1 h√¨nh ri√™ng cho m·ªói marker) -->
      <a-image id="img-cho" material="src: #image1" width="2.5" height="1.5" position="0 0.5 -5" visible="false"></a-image>
<a-image id="img-chua" material="src: #image4" width="2.5" height="1.5" position="0 0.5 -5" visible="false"></a-image>
<a-image id="img-vang" material="src: #image7" width="2.5" height="1.5" position="0 0.5 -5" visible="false"></a-image>
<a-image id="img-somrong" material="src: #image10" width="2.5" height="1.5" position="0 0.5 -5" visible="false"></a-image>



      <a-entity camera></a-entity>
    </a-scene>

    <!-- N√∫t T·∫Øt -->
    <button id="close-button">T·∫Øt</button>

    <script>
      window.addEventListener("load", () => {
        let isLocked = false;
        let intervalId = null;
        let currentAudio = null;
        let currentImage = null;
        let closeButton = document.getElementById("close-button");

        function setupMarker(markerId, imageElementId, audioSrc, imageSources) {
          let audio = new Audio(audioSrc);
          let imageIndex = 0;
          const marker = document.getElementById(markerId);
          const imageElement = document.getElementById(imageElementId);

          marker.addEventListener("markerFound", () => {
            if (isLocked) return;
            isLocked = true;

            console.log(`üìç Marker ${markerId} ƒë∆∞·ª£c ph√°t hi·ªán!`);

            // ·∫®n t·∫•t c·∫£ h√¨nh tr∆∞·ªõc ƒë√≥
            document
              .querySelectorAll("a-image")
              .forEach((img) => img.setAttribute("visible", "false"));

            // Hi·ªÉn th·ªã h√¨nh ·∫£nh m·ªõi
            currentImage = imageElement;
            currentImage.setAttribute("visible", "true");

            // Ph√°t √¢m thanh
            currentAudio = audio;
            currentAudio.currentTime = 0;
            currentAudio
              .play()
              .catch((err) => console.warn("‚ùå L·ªói ph√°t √¢m thanh:", err));

            // Hi·ªán n√∫t "T·∫Øt"
            closeButton.style.display = "block";

            // ƒê·ªïi ·∫£nh m·ªói 3 gi√¢y
            if (!intervalId) {
              intervalId = setInterval(() => {
                imageIndex = (imageIndex + 1) % imageSources.length;
                imageElement.setAttribute(
                  "material",
                  "src",
                  imageSources[imageIndex]
                );
              }, 3000);
            }
          });

          marker.addEventListener("markerLost", () => {
            console.log(`‚ö† Marker ${markerId} m·∫•t, nh∆∞ng h√¨nh ·∫£nh v·∫´n gi·ªØ!`);
            if (isLocked) {
              currentImage.setAttribute("visible", "true"); // Gi·ªØ h√¨nh ·∫£nh
            }
          });

          closeButton.addEventListener("click", () => {
            if (isLocked) {
              console.log(`üîì ƒê√£ t·∫Øt n·ªôi dung c·ªßa ${markerId}`);

              // D·ª´ng √¢m thanh
              if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
              }

              // D·ª´ng ƒë·ªïi ·∫£nh
              if (intervalId) {
                clearInterval(intervalId);
                intervalId = null;
              }

              // ·∫®n h√¨nh ·∫£nh
              if (currentImage) {
                currentImage.setAttribute("visible", "false");
              }

              // ·∫®n n√∫t "T·∫Øt"
              closeButton.style.display = "none";

              // Reset tr·∫°ng th√°i ƒë·ªÉ qu√©t l·∫°i
              isLocked = false;
            }
          });
        }

        // C·∫•u h√¨nh t·ª´ng marker
        setupMarker("marker-cho", "img-cho", "./media/Audio/chobenthanh.mp4", [
          "#image1",
          "#image2",
          "#image3",
        ]);
        setupMarker("marker-chua", "img-chua", "./media/Audio/chuamotcot.mp4", [
          "#image4",
          "#image5",
          "#image6",
        ]);
        setupMarker("marker-vang", "img-vang", "./media/Audio/cauvang.mp4", [
          "#image7",
          "#image8",
          "#image9",
        ]);
        setupMarker(
          "marker-somrong",
          "img-somrong",
          "./media/Audio/chuasomrong.mp4",
          ["#image10", "#image11", "#image12"]
        );
      });
    </script>
  </body>
</html>
